<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facebook Analytics Dashboard - Enhanced</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
            text-align: center;
        }

        h1 {
            color: #333;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .stat-value {
            font-size: 2.5em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .stat-label {
            color: #666;
            font-size: 1em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .chart-card.full-width {
            grid-column: 1 / -1;
        }

        .chart-card h2 {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 3px solid #667eea;
        }

        .chart-container {
            position: relative;
            height: 350px;
        }

        .chart-container.small {
            height: 300px;
        }

        .content-section {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        h2 {
            color: #333;
            margin-bottom: 20px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
        }

        td {
            padding: 15px;
            border-bottom: 1px solid #eee;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
            font-size: 1.2em;
        }

        .error {
            background: #fee;
            border: 2px solid #fcc;
            color: #c33;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .post-text {
            max-width: 400px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .badge-reactions {
            background: #ffeaa7;
            color: #d63031;
        }

        .badge-comments {
            background: #74b9ff;
            color: #0984e3;
        }

        .badge-shares {
            background: #a29bfe;
            color: #6c5ce7;
        }

        .api-status {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 15px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            font-size: 0.9em;
            z-index: 1000;
        }

        .status-dot {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            animation: pulse 2s infinite;
        }

        .status-online {
            background: #00b894;
        }

        .status-offline {
            background: #d63031;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .nav-tab {
            padding: 10px 20px;
            border: none;
            background: #f0f0f0;
            border-radius: 5px 5px 0 0;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s ease;
        }

        .nav-tab:hover {
            background: #e0e0e0;
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üìä Facebook Analytics Dashboard</h1>
            <p class="subtitle">Advanced data visualization and insights with interactive charts</p>
        </header>

        <!-- Statistics Cards -->
        <div class="stats-grid" id="stats">
            <div class="loading">Loading statistics...</div>
        </div>

        <!-- Charts Section -->
        <div class="charts-grid">
            <!-- Top Authors Bar Chart -->
            <div class="chart-card">
                <h2>üë• Top Authors by Reactions</h2>
                <div class="chart-container">
                    <canvas id="authorsBarChart"></canvas>
                </div>
            </div>

            <!-- Engagement Distribution Pie Chart -->
            <div class="chart-card">
                <h2>üìä Posts Distribution by Author</h2>
                <div class="chart-container small">
                    <canvas id="postsDistributionPie"></canvas>
                </div>
            </div>

            <!-- Engagement Types Donut Chart -->
            <div class="chart-card">
                <h2>üí¨ Engagement Types Breakdown</h2>
                <div class="chart-container small">
                    <canvas id="engagementDonut"></canvas>
                </div>
            </div>

            <!-- Daily Trends Line Chart (Full Width) -->
            <div class="chart-card full-width">
                <h2>üìà Daily Engagement Trends</h2>
                <div class="chart-container">
                    <canvas id="dailyTrendsLine"></canvas>
                </div>
            </div>

            <!-- Top Posts Stacked Bar Chart (Full Width) -->
            <div class="chart-card full-width">
                <h2>üèÜ Top Posts - Engagement Breakdown</h2>
                <div class="chart-container">
                    <canvas id="postsStackedBar"></canvas>
                </div>
            </div>
        </div>

        <!-- Data Tables -->
        <div class="content-section">
            <h2>üìã Detailed Data Tables</h2>
            <div class="nav-tabs">
                <button class="nav-tab active" onclick="showTab('posts')">Top Posts</button>
                <button class="nav-tab" onclick="showTab('comments')">Recent Comments</button>
                <button class="nav-tab" onclick="showTab('authors')">Top Authors</button>
            </div>

            <div id="tab-posts" class="tab-content">
                <div id="posts">
                    <div class="loading">Loading posts...</div>
                </div>
            </div>

            <div id="tab-comments" class="tab-content" style="display:none;">
                <div id="comments">
                    <div class="loading">Loading comments...</div>
                </div>
            </div>

            <div id="tab-authors" class="tab-content" style="display:none;">
                <div id="authors">
                    <div class="loading">Loading authors...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="api-status">
        <span class="status-dot status-offline" id="statusDot"></span>
        <span id="statusText">Connecting to API...</span>
    </div>

    <script>
        const API_URL = 'http://localhost:3002';
        let charts = {};

        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.nav-tab').forEach(el => el.classList.remove('active'));

            document.getElementById(`tab-${tabName}`).style.display = 'block';
            event.target.classList.add('active');
        }

        // Check API health
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_URL}/health`);
                const data = await response.json();

                document.getElementById('statusDot').className = 'status-dot status-online';
                document.getElementById('statusText').textContent = 'API Connected';
                return true;
            } catch (error) {
                document.getElementById('statusDot').className = 'status-dot status-offline';
                document.getElementById('statusText').textContent = 'API Offline';
                return false;
            }
        }

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const data = await response.json();

                const statsHTML = `
                    <div class="stat-card">
                        <div class="stat-value">${data.total_posts?.toLocaleString() || 0}</div>
                        <div class="stat-label">Total Posts</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.total_comments?.toLocaleString() || 0}</div>
                        <div class="stat-label">Total Comments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.total_reactions?.toLocaleString() || 0}</div>
                        <div class="stat-label">Total Reactions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.total_shares?.toLocaleString() || 0}</div>
                        <div class="stat-label">Total Shares</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.unique_authors?.toLocaleString() || 0}</div>
                        <div class="stat-label">Unique Authors</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">${data.posts_with_images?.toLocaleString() || 0}</div>
                        <div class="stat-label">Posts with Images</div>
                    </div>
                `;

                document.getElementById('stats').innerHTML = statsHTML;
            } catch (error) {
                document.getElementById('stats').innerHTML = '<div class="error">Failed to load statistics</div>';
            }
        }

        // Create Top Authors Bar Chart
        async function createAuthorsBarChart() {
            try {
                const response = await fetch(`${API_URL}/api/authors/top?limit=10`);
                const data = await response.json();

                if (charts.authorsBar) charts.authorsBar.destroy();

                const ctx = document.getElementById('authorsBarChart').getContext('2d');
                charts.authorsBar = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(a => a.author || 'Unknown'),
                        datasets: [{
                            label: 'Total Reactions',
                            data: data.map(a => a.total_reactions || 0),
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to create authors bar chart:', error);
            }
        }

        // Create Posts Distribution Pie Chart
        async function createPostsDistributionPie() {
            try {
                const response = await fetch(`${API_URL}/api/authors/top?limit=5`);
                const data = await response.json();

                if (charts.postsPie) charts.postsPie.destroy();

                const ctx = document.getElementById('postsDistributionPie').getContext('2d');
                charts.postsPie = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: data.map(a => a.author || 'Unknown'),
                        datasets: [{
                            data: data.map(a => a.total_posts || 0),
                            backgroundColor: [
                                'rgba(102, 126, 234, 0.8)',
                                'rgba(118, 75, 162, 0.8)',
                                'rgba(255, 99, 132, 0.8)',
                                'rgba(54, 162, 235, 0.8)',
                                'rgba(255, 206, 86, 0.8)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to create posts distribution pie:', error);
            }
        }

        // Create Engagement Donut Chart
        async function createEngagementDonut() {
            try {
                const response = await fetch(`${API_URL}/api/stats`);
                const data = await response.json();

                if (charts.engagementDonut) charts.engagementDonut.destroy();

                const ctx = document.getElementById('engagementDonut').getContext('2d');
                charts.engagementDonut = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Reactions', 'Comments', 'Shares'],
                        datasets: [{
                            data: [
                                data.total_reactions || 0,
                                data.total_comments || 0,
                                data.total_shares || 0
                            ],
                            backgroundColor: [
                                'rgba(255, 234, 167, 0.8)',
                                'rgba(116, 185, 255, 0.8)',
                                'rgba(162, 155, 254, 0.8)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right'
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to create engagement donut:', error);
            }
        }

        // Create Daily Trends Line Chart
        async function createDailyTrendsLine() {
            try {
                const response = await fetch(`${API_URL}/api/stats/daily?limit=30`);
                const data = await response.json();

                if (charts.dailyLine) charts.dailyLine.destroy();

                const ctx = document.getElementById('dailyTrendsLine').getContext('2d');
                charts.dailyLine = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.map(d => new Date(d.date).toLocaleDateString('id-ID')),
                        datasets: [
                            {
                                label: 'Reactions',
                                data: data.map(d => d.total_reactions || 0),
                                borderColor: 'rgba(255, 234, 167, 1)',
                                backgroundColor: 'rgba(255, 234, 167, 0.2)',
                                tension: 0.4
                            },
                            {
                                label: 'Comments',
                                data: data.map(d => d.total_comments || 0),
                                borderColor: 'rgba(116, 185, 255, 1)',
                                backgroundColor: 'rgba(116, 185, 255, 0.2)',
                                tension: 0.4
                            },
                            {
                                label: 'Shares',
                                data: data.map(d => d.total_shares || 0),
                                borderColor: 'rgba(162, 155, 254, 1)',
                                backgroundColor: 'rgba(162, 155, 254, 0.2)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to create daily trends line:', error);
            }
        }

        // Create Posts Stacked Bar Chart
        async function createPostsStackedBar() {
            try {
                const response = await fetch(`${API_URL}/api/posts/top/engagement?limit=10`);
                const data = await response.json();

                if (charts.postsStacked) charts.postsStacked.destroy();

                const ctx = document.getElementById('postsStackedBar').getContext('2d');
                charts.postsStacked = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.map(p => (p.author || 'Unknown').substring(0, 20) + '...'),
                        datasets: [
                            {
                                label: 'Reactions',
                                data: data.map(p => p.reactions || 0),
                                backgroundColor: 'rgba(255, 234, 167, 0.8)'
                            },
                            {
                                label: 'Comments',
                                data: data.map(p => p.comments || 0),
                                backgroundColor: 'rgba(116, 185, 255, 0.8)'
                            },
                            {
                                label: 'Shares',
                                data: data.map(p => p.shares || 0),
                                backgroundColor: 'rgba(162, 155, 254, 0.8)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        },
                        scales: {
                            x: {
                                stacked: true
                            },
                            y: {
                                stacked: true,
                                beginAtZero: true
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Failed to create posts stacked bar:', error);
            }
        }

        // Load top posts
        async function loadPosts() {
            try {
                const response = await fetch(`${API_URL}/api/posts/top/engagement?limit=10`);
                const data = await response.json();

                if (data.length === 0) {
                    document.getElementById('posts').innerHTML = '<p>No posts found</p>';
                    return;
                }

                const postsHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Author</th>
                                <th>Text</th>
                                <th>Reactions</th>
                                <th>Comments</th>
                                <th>Shares</th>
                                <th>Engagement</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(post => `
                                <tr>
                                    <td><strong>${post.author || 'Unknown'}</strong></td>
                                    <td class="post-text">${post.text_preview || 'No text'}</td>
                                    <td><span class="badge badge-reactions">${post.reactions?.toLocaleString() || 0}</span></td>
                                    <td><span class="badge badge-comments">${post.comments?.toLocaleString() || 0}</span></td>
                                    <td><span class="badge badge-shares">${post.shares?.toLocaleString() || 0}</span></td>
                                    <td><strong>${post.engagement_score?.toLocaleString() || 0}</strong></td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('posts').innerHTML = postsHTML;
            } catch (error) {
                document.getElementById('posts').innerHTML = '<div class="error">Failed to load posts</div>';
            }
        }

        // Load recent comments
        async function loadComments() {
            try {
                const response = await fetch(`${API_URL}/api/comments?limit=20`);
                const data = await response.json();

                if (!data.data || data.data.length === 0) {
                    document.getElementById('comments').innerHTML = '<p>No comments found</p>';
                    return;
                }

                const commentsHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Author</th>
                                <th>Comment</th>
                                <th>Reactions</th>
                                <th>Post Author</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.data.map(comment => `
                                <tr>
                                    <td><strong>${comment.comment_author || 'Unknown'}</strong></td>
                                    <td class="post-text">${comment.comment_text || 'No text'}</td>
                                    <td><span class="badge badge-reactions">${comment.comment_reactions || 0}</span></td>
                                    <td>${comment.post_author || 'Unknown'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('comments').innerHTML = commentsHTML;
            } catch (error) {
                document.getElementById('comments').innerHTML = '<div class="error">Failed to load comments</div>';
            }
        }

        // Load top authors
        async function loadAuthors() {
            try {
                const response = await fetch(`${API_URL}/api/authors/top?limit=10`);
                const data = await response.json();

                if (data.length === 0) {
                    document.getElementById('authors').innerHTML = '<p>No authors found</p>';
                    return;
                }

                const authorsHTML = `
                    <table>
                        <thead>
                            <tr>
                                <th>Author</th>
                                <th>Total Posts</th>
                                <th>Total Reactions</th>
                                <th>Total Comments</th>
                                <th>Total Shares</th>
                                <th>Avg Reactions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.map(author => `
                                <tr>
                                    <td><strong>${author.author || 'Unknown'}</strong></td>
                                    <td>${author.total_posts?.toLocaleString() || 0}</td>
                                    <td><span class="badge badge-reactions">${author.total_reactions?.toLocaleString() || 0}</span></td>
                                    <td><span class="badge badge-comments">${author.total_comments?.toLocaleString() || 0}</span></td>
                                    <td><span class="badge badge-shares">${author.total_shares?.toLocaleString() || 0}</span></td>
                                    <td>${author.avg_reactions?.toLocaleString() || 0}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('authors').innerHTML = authorsHTML;
            } catch (error) {
                document.getElementById('authors').innerHTML = '<div class="error">Failed to load authors</div>';
            }
        }

        // Initialize dashboard
        async function init() {
            await checkAPIHealth();
            await loadStats();

            // Create all charts
            await createAuthorsBarChart();
            await createPostsDistributionPie();
            await createEngagementDonut();
            await createDailyTrendsLine();
            await createPostsStackedBar();

            // Load tables
            await loadPosts();
            await loadComments();
            await loadAuthors();

            // Refresh every 30 seconds
            setInterval(async () => {
                await checkAPIHealth();
                await loadStats();
                await createAuthorsBarChart();
                await createPostsDistributionPie();
                await createEngagementDonut();
                await createDailyTrendsLine();
                await createPostsStackedBar();
            }, 30000);
        }

        // Start when page loads
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
